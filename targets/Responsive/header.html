<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<!--
Responsive 1.1.1 by Emmanuel King Turner 
(eturnerx@gmail.com / Twitter: @stormrose / http://eturnerx.com)

based on Initializr (uses Modernizr & jQuery) & The Twine Story Format "Sugarcane"

CREDITS:
Leon Arnott: data-tags idea (http://www.glorioustrainwrecks.com/node/5013) 


Sugarcane 1.2.1 is based on:
TiddlyWiki 1.2.39 by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Published under a BSD open source license
Copyright (c) Osmosoft Limited 2005

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the Osmosoft Limited nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
-->
<title>Responsive</title>
<meta name="viewport" content="width=device-width">
<script>
(function(){

function clone(a) {
    var b = {};
    for (var property in a) {
        b[property] = a[property]
    }
    return b
}

function insertElement(a, d, f, c, e) {
    var b = document.createElement(d);
    if (f) {
        b.id = f
    }
    if (c) {
        b.className = c
    }
    if (e) {
        insertText(b, e)
    }
    if (a) {
        a.appendChild(b)
    }
    return b
}

function insertText(a, b) {
    return a.appendChild(document.createTextNode(b))
}

function removeChildren(a) {
    while (a.hasChildNodes()) {
        a.removeChild(a.firstChild)
    }
}

function setPageElement(c, b, a) {
    var place;
    if (place = document.getElementById(c)) {
        removeChildren(place);
        if (tale.has(b)) {
            new Wikifier(place, tale.get(b).text)
        } else {
            new Wikifier(place, a)
        }
    }
}

function addStyle(b) {
    if (document.createStyleSheet) {
        document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd", "&nbsp;<style>" + b + "</style>")
    } else {
        var a = document.createElement("style");
        a.appendChild(document.createTextNode(b));
        document.getElementsByTagName("head")[0].appendChild(a)
    }
}

function throwError(a, b) {
    new Wikifier(a, "'' @@ " + b + " @@ ''")
}
Math.easeInOut = function (a) {
    return (1 - ((Math.cos(a * Math.PI) + 1) / 2))
};
String.prototype.readMacroParams = function () {
    var c = new RegExp("(?:\\s*)(?:(?:\"([^\"]*)\")|(?:'([^']*)')|(?:\\[\\[([^\\]]*)\\]\\])|([^\"'\\s]\\S*))", "mg");
    var b = [];
    do {
        var a = c.exec(this);
        if (a) {
            if (a[1]) {
                b.push(a[1]);
            } else if (a[2]) {
                b.push(a[2]);
            } else if (a[3]) {
                b.push(a[3]);
            } else if (a[4]) {
                b.push(a[4]);
            }
        }
    } while (a);
    return b
};
String.prototype.readBracketedList = function () {
    var b = "\\[\\[([^\\]]+)\\]\\]";
    var a = "[^\\s$]+";
    var e = "(?:" + b + ")|(" + a + ")";
    var d = new RegExp(e, "mg");
    var f = [];
    do {
        var c = d.exec(this);
        if (c) {
            if (c[1]) {
                f.push(c[1])
            } else {
                if (c[2]) {
                    f.push(c[2])
                }
            }
        }
    } while (c);
    return (f)
};
String.prototype.trim || (String.prototype.trim = function () {
    return this.replace(/^\s\s*/, "").replace(/\s\s*$/, "")
});
String.prototype.unDash = function () {
    var s = this.split("-");
    if (s.length > 1) for (var t = 1; t < s.length; t++)
    s[t] = s[t].substr(0, 1).toUpperCase() + s[t].substr(1);
    return s.join("");
}
Array.prototype.indexOf || (Array.prototype.indexOf = function (b, d) {
    d = (d == null) ? 0 : d;
    var a = this.length;
    for (var c = d; c < a; c++) {
        if (this[c] == b) {
            return c
        }
    }
    return -1
});

function fade(f, c) {
    var h;
    var e = f.cloneNode(true);
    var g = (c.fade == "in") ? 1 : -1;
    f.parentNode.replaceChild(e, f);
    if (c.fade == "in") {
        h = 0;
        e.style.visibility = "visible"
    } else {
        h = 1
    }
    b(e, h);
    var a = window.setInterval(d, 25);

    function d() {
        h += 0.05 * g;
        b(e, Math.easeInOut(h));
        if (((g == 1) && (h >= 1)) || ((g == -1) && (h <= 0))) {
            f.style.visibility = (c.fade == "in") ? "visible" : "hidden";
			if (e.parentNode) {
				e.parentNode.replaceChild(f, e);
			}
            window.clearInterval(a);
            if (c.onComplete) {
                c.onComplete()
            }
        }
    }

    function b(k, j) {
        var l = Math.floor(j * 100);
        k.style.zoom = 1;
        k.style.filter = "alpha(opacity=" + l + ")";
        k.style.opacity = j
    }
}

function scrollWindowTo(e) {
    var d = window.scrollY ? window.scrollY : document.body.scrollTop;
    var g = k(e);
    var c = Math.abs(d - g);
    var b = 0;
    var j = (d > g) ? -1 : 1;
    var f = window.setInterval(h, 25);

    function h() {
        b += 0.1;
        window.scrollTo(0, d + j * (c * Math.easeInOut(b)));
        if (b >= 1) {
            window.clearInterval(f)
        }
    }

    function k(o) {
        var p = a(o);
        var q = p + o.offsetHeight;
        var l = window.scrollY ? window.scrollY : document.body.scrollTop;
        var m = window.innerHeight ? window.innerHeight : document.body.clientHeight;
        var n = l + m;
        if (p < l) {
            return p
        } else {
            if (q > n) {
                if (o.offsetHeight < m) {
                    return (p - (m - o.offsetHeight) + 20)
                } else {
                    return p
                }
            } else {
                return p
            }
        }
    }

    function a(l) {
        var m = 0;
        while (l.offsetParent) {
            m += l.offsetTop;
            l = l.offsetParent
        }
        return m
    }
}

function History() {
    this.history = [{
        passage: null,
        variables: {},
        hash: null
    }]
}
History.prototype.init = function () {
    var a = this;
    if (!this.restore()) {
        this.display("Start", null)
    }
    if (!hasPushState) {
        this.hash = window.location.hash;
        this.interval = window.setInterval(function () {
            a.watchHash.apply(a)
        }, 250)
    }
};
History.prototype.restart = function () {
    window.location.reload();
};
History.prototype.save = function (c) {
    var a = "";
    for (var b = this.history.length - 1; b >= 0; b--) {
        if ((this.history[b].passage) && (this.history[b].passage.id)) {
            a += this.history[b].passage.id.toString(36) + "."
        }
    }
    return "#" + a.substr(0, a.length - 1)
};
History.prototype.restore = function () {
    try {
		if ((window.location.hash == "") || (window.location.hash == "#")) {
			return false
		}
        if (window.location.hash.substr(0, 2) == '#!') {
            var mt = window.location.hash.substr(2).split('_').join(' ');
            document.getElementById('passages').appendChild(this.display(mt, null, 'quietly'));
            return true;
        }
		var a = window.location.hash.replace("#", "").split(".");
		for (var b = 0; b < a.length; b++) {
			var g = parseInt(a[b], 36);
			if (!tale.has(g)) {
				return false
			}
			if (b == a.length - 1) {
			  this.display(g, null, f);
			}
			else
			  tale.get(g).render();
	    }
	    return true
    } catch (d) {
        return false
    }
};
History.prototype.watchHash = function () {
    if (window.location.hash != this.hash) {
        if ((window.location.hash != "") && (window.location.hash != "#")) {
            this.history = [{
                passage: null,
                variables: {}
            }];
            removeChildren(document.getElementById("passages"));
            if (!this.restore()) {
                alert("The passage you had previously visited could not be found.")
            }
        } else {
            window.location.reload()
        }
        this.hash = window.location.hash
    }
};
var version = {
    major: 2,
    minor: 1,
    revision: 0,
    date: new Date("January 1, 2013"),
    extensions: {}
};
var tale, state, macros = window.macros = {};

window.onpopstate = function(e) {
	if (e.state && e.state.length > 0) {
		state.history = e.state;
	} else {
		state = new History();
		state.init();
	}
	state.display(state.history[0].passage.title,null,"back");
}
macros.refresh = {
    handler: function (a, b, c) {
        window.location.reload()
    }
};
version.extensions.displayMacro = {
    major: 1,
    minor: 0,
    revision: 0
};
macros.display = {
    handler: function (a, b, c) {
        if (c[0] == "_previous") {
            if (state.history[1]) {
                for (var d = 1; d <= state.history.length; d++) {
                    if (state.history[d].passage.title != state.history[0].passage.title) {
                        break
                    }
                }
                var e = state.history[d].passage.title;
                new Wikifier(a, tale.get(e).text)
            } else {
                return
            }
        } else {
            if (tale.get(c[0]).id == undefined) {
                throwError(a, "The " + c[0] + " passage does not exist");
                return
            } else {
                new Wikifier(a, tale.get(c[0]).text)
            }
        }
    }
};
version.extensions.actionsMacro = {
    major: 1,
    minor: 2,
    revision: 0
};
macros.actions = {
    handler: function (a, f, g) {
        var e = insertElement(a, "ul");
        if (!state.history[0].variables["actions clicked"]) {
            state.history[0].variables["actions clicked"] = {}
        }
        for (var b = 0; b < g.length; b++) {
            if (state.history[0].variables["actions clicked"][g[b]]) {
                continue
            }
            var d = insertElement(e, "li");
            var c = Wikifier.createInternalLink(d, g[b]);
            insertText(c, g[b]);
            c.onclick = function () {
                state.history[0].variables["actions clicked"][this.id] = true;
                state.display(this.id, c)
            }
        }
    }
};
version.extensions.printMacro = {
    major: 1,
    minor: 1,
    revision: 1
};
macros['print'] = {
    handler: function (place, macroName, params, parser) {
        try {
            var output = eval(parser.fullArgs());
            if (output != null || !isNaN(output)) {
                new Wikifier(place, output.toString());
            }
        } catch (e) {
            throwError(place, "printMacro bad expression: " + e.message);
        }
    }
};
version.extensions.setMacro = {
    major: 1,
    minor: 1,
    revision: 0
};
macros.set = {
    handler: function (a, b, c, d) {
		var s, v = c[0];
		// If first value is set uninitialised, change to 0 before
		// calculation. If it's numeric addition, it will behave
		// intuitively. String concatenation is an unlikely use case.
		if (c[0] && c[0][0]=="$") {
			s = state.history[0].variables;
			if (typeof s[c[0].slice(1)] == "undefined") {
				s[c[0].slice(1)] = 0;
			}
		}
        macros.set.run(a,d.fullArgs())
    },
    run: function (a,expression) {
        try {
            return eval(Wikifier.parse(expression))
        } catch (e) {
            throwError(a, "bad expression: " + e.message)
        }
    }
};
version.extensions.ifMacros = {
    major: 2,
    minor: 0,
    revision: 0
};
macros["if"] = {
    handler: function (place, macroName, params, parser) {
        var conditions = [],
		    clauses = [],
            srcOffset = parser.source.indexOf(">>", parser.matchStart) + 2,
            src = parser.source.slice(srcOffset),
            endPos = -1,
		    currentCond = parser.fullArgs(),
		    currentClause = "",
			t = 0,
			nesting = 0;
        for (var i = 0; i < src.length; i++) {
            if (src.substr(i, 9) == "<<endif>>") {
                nesting--;
                if (nesting < 0) {
                    endPos = srcOffset + i + 9;
					conditions.push(currentCond);
					clauses.push(currentClause);
                    break;
                }
            }
            if ((src.substr(i, 6) == "<<else") && nesting == 0) {
                conditions.push(currentCond);
				clauses.push(currentClause);
				currentClause="";
				t = src.indexOf(">>",i+6);
				if(src.substr(i+6,4)==" if ") {
				    currentCond = Wikifier.parse(src.slice(i+10,t));
				}
				else {
				    currentCond = "true";
				}
                i = t+2;
            }
            if (src.substr(i, 5) == "<<if ") {
                nesting++;
            }
            currentClause += src.charAt(i);
        }
        try {
            if (endPos != -1) {
                parser.nextMatch = endPos;
				for(i=0;i<clauses.length;i++) {
				    if (eval(conditions.shift())) {
				        new Wikifier(place, clauses[i].trim());
						break;
				    }
                }
            } else {
                throwError(place, "can't find matching endif");
            }
        } catch (e) {
            throwError(place, "bad condition: " + e.message);
        }
    }
};
macros["else"] = macros["endif"] = {
    handler: function () {}
};

version.extensions.rememberMacro = {
    major: 2,
    minor: 0,
    revision: 0
};
macros['remember'] = {
    handler: function (place, macroName, params, parser) {
        var statement = parser.fullArgs();
        var variable, value;
        macros.set.run(place,statement);
        var variableSigil = Wikifier.parse("$");
        variableSigil = variableSigil.replace("[", "\\[");
        variableSigil = variableSigil.replace("]", "\\]");
        variable = statement.match(new RegExp(variableSigil + "(\\w+)", "i"))[1];
        value = eval(Wikifier.parse("$" + variable));
        switch (typeof value) {
        case "string":
            value = '"' + value.replace(/"/g, '\\"') + '"';
            break;
        case "number":
        case "boolean":
            break;
        default:
            throwError(place, "can't remember $" + variable + " (" + (typeof value) + ")");
            return;
        }
        if (this.uselocalstorage) {
            localStorage[this.prefix + variable] = value;
        } else {
            document.cookie = this.prefix + variable + "=" + value + "; expires=" + this.expire;
        }
    },
    init: function () {
        var expiredate = new Date();
        expiredate.setYear(expiredate.getFullYear() + 1);
        this.expire = expiredate.toGMTString();
        if (tale.has("StoryTitle")) {
            this.prefix = tale.get("StoryTitle").text + "_";
        } else {
            this.prefix = "__twineremember_";
        }
        if (typeof localStorage != 'undefined' && localStorage !== null) {
            this.uselocalstorage = true;
            for (var i in localStorage) {
                if (i.indexOf(this.prefix) == 0) {
                    var variable = i.substr(this.prefix.length);
                    var value = localStorage[i];
                    eval(Wikifier.parse('$' + variable + ' = ' + value));
                }
            }
        } else {
            this.uselocalstorage = false;
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
                var bits = cookies[i].split("=");
                if (bits[0].trim().indexOf(this.prefix) == 0) {
                    var statement = cookies[i].replace(this.prefix, "$");
                    eval(Wikifier.parse(statement));
                }
            }
        }
    },
    expire: null,
    uselocalstorage: null,
    prefix: null,
};

version.extensions.SilentlyMacro = {
    major: 1,
    minor: 0,
    revision: 0
};
macros.silently = {
    handler: function (g, e, f, b) {
        var h = insertElement(null, 'div');
        var k = b.source.indexOf('>>', b.matchStart) + 2;
        var a = b.source.slice(k);
        var d = -1;
        var c = '';
        var l = 0;
        for (var i = 0; i < a.length; i++) {
            if (a.substr(i, 15) == '<<endsilently>>') {
                if (l == 0) {
                    d = k + i + 15;
                    break;
                } else {
                    l--;
                }
            } else if (a.substr(i, 12) == '<<silently>>') {
                l++;
            } else {
                c += a.charAt(i);
            }
        };
        if (d != -1) {
            new Wikifier(h, c);
            b.nextMatch = d;
        } else {
            throwError(g, "can't find matching endsilently");
        }
    }
};
macros.endsilently = {
    handler: function () {}
};

function Passage(c, b, a, ofunc, okey) {
    this.title = c;
    if (b) {
        this.id = a;
        if (ofunc != null && typeof ofunc == 'function' && okey != null) {
            var t = b.firstChild ? b.firstChild.nodeValue : "";
            t = ofunc(t, okey);
            this.initialText = this.text = Passage.unescapeLineBreaks(t);
            this.tags = b.getAttribute("tags");
            if (typeof this.tags == "string") {
                this.tags = ofunc(this.tags, okey);
                this.tags = this.tags.readBracketedList();
            } else this.tags = [];
        } else {
            this.initialText = this.text = Passage.unescapeLineBreaks(b.firstChild ? b.firstChild.nodeValue : "");
            this.tags = b.getAttribute("tags");
            if (typeof this.tags == "string") this.tags = this.tags.readBracketedList();
            else this.tags = [];
        }
    } else {
        this.initialText = this.text = '@@This passage does not exist: ' + c + '@@';
        this.tags = [];
    }
}
Passage.unescapeLineBreaks = function (a) {
    if (a && a != "") {
        return a.replace(/\\n/mg, "\n").replace(/\\s/mg, "\\").replace(/\\/mg, "\\").replace(/\r/mg, "")
    } else {
        return ""
    }
};

function Tale() {
    this.passages = {};
    this.storysettings = {};
	var a,b,c,lines,i,kv,ns,nsc,nope,tiddlerTitle = '';
    function deswap(t, k) {
		var i,c,p,p1,r = '';
		for (i = 0; i < t.length; i++) {
			c = t.charAt(i);
			p = k.indexOf(c);
			if (p > -1) {
				p1 = p + (p % 2 == 0 ? 1 : -1);
				if (p1 >= k.length) p1 = p;
				c = k.charAt(p1);
			}
			r = r + c;
		}
		return r
    };
    //Look for and load the StorySettings
    if (document.normalize) document.normalize();
    a = document.getElementById("storeArea").childNodes;
    for (b = 0; b < a.length; b++) {
        c = a[b];
        if (c.getAttribute && c.getAttribute("tiddler") == 'StorySettings') {
            lines = new Passage('StorySettings', c, 0, null, null).text.split('\n');
            for (i in lines) {
                if (lines[i].indexOf(':') > -1) {
                    kv = lines[i].split(':');
                    kv[0] = kv[0].replace(/^\s+|\s+$/g, '');
                    kv[1] = kv[1].replace(/^\s+|\s+$/g, '');
                    this.storysettings[kv[0]] = kv[1];
                }
            }
        }
    }
    //Load in the passages
    if (this.storysettings['Obfuscate'] == 'SWAP') {
        ns = '';
		nope = ":\\\"n0";
        for (i = 0; i < this.storysettings['ObfuscateKey'].length; i++) {
            nsc = this.storysettings['ObfuscateKey'][i];
            if (ns.indexOf(nsc) == -1 && nope.indexOf(nsc) == -1) ns = ns + nsc;
        }
        this.storysettings['ObfuscateKey'] = ns;
        for (b = 0; b < a.length; b++) {
            c = a[b];
            if (c.getAttribute && (tiddlerTitle = c.getAttribute("tiddler"))) {
                if (tiddlerTitle != 'StorySettings') tiddlerTitle = deswap(tiddlerTitle, this.storysettings['ObfuscateKey']);
                this.passages[tiddlerTitle] = new Passage(tiddlerTitle, c, b, deswap, this.storysettings['ObfuscateKey']);
            }
        }
    } else {
        for (b = 0; b < a.length; b++) {
            c = a[b];
            if (c.getAttribute && (tiddlerTitle = c.getAttribute("tiddler"))) {
                this.passages[tiddlerTitle] = new Passage(tiddlerTitle, c, b, null, null)
            }
        }
    }
    this.title = (this.passages.StoryTitle ? this.passages.StoryTitle.text : document.title);
}
Tale.prototype.has = function (a) {
    if (typeof a == "string") {
        return (this.passages[a] != null)
    } else {
        for (i in this.passages) {
            if (this.passages[i].id == a) {
                return true
            }
        }
        return false
    }
};
Tale.prototype.get = function (a) {
    if (typeof a == "string") {
        return this.passages[a] || new Passage(a)
    } else {
        for (i in this.passages) {
            if (this.passages[i].id == a) {
                return this.passages[i]
            }
        }
    }
};
Tale.prototype.lookup = function (h, g, a) {
    var d = [];
    for (var c in this.passages) {
        var f = this.passages[c];
        var e = false;
        for (var b = 0; b < f[h].length; b++) {
            if (f[h][b] == g) {
                d.push(f)
            }
        }
    }
    if (!a) {
        a = "title"
    }
    d.sort(function (k, j) {
        if (k[a] == j[a]) {
            return (0)
        } else {
            return (k[a] < j[a]) ? -1 : +1
        }
    });
    return d
};
function Wikifier(place, source) {
    this.source = source;
    this.output = place;
    this.nextMatch = 0;
    this.assembleFormatterMatches(Wikifier.formatters);
    this.subWikify(this.output);
};

Wikifier.prototype.assembleFormatterMatches = function (formatters) {
    this.formatters = [];
    var pattern = [];

    for (var n = 0; n < formatters.length; n++) {
        pattern.push("(" + formatters[n].match + ")");
        this.formatters.push(formatters[n]);
    };

    this.formatterRegExp = new RegExp(pattern.join("|"), "mg");
};

Wikifier.prototype.subWikify = function (output, terminator) {
    // Temporarily replace the output pointer
    var oldOutput = this.output;
    this.output = output;

    // Prepare the terminator RegExp
    var terminatorRegExp = terminator ? new RegExp("(" + terminator + ")", "mg") : null;
    do {
        // Prepare the RegExp match positions
        this.formatterRegExp.lastIndex = this.nextMatch;

        if (terminatorRegExp) terminatorRegExp.lastIndex = this.nextMatch;

        // Get the first matches
        var formatterMatch = this.formatterRegExp.exec(this.source);
        var terminatorMatch = terminatorRegExp ? terminatorRegExp.exec(this.source) : null;

        // Check for a terminator match
        if (terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
            // Output any text before the match
            if (terminatorMatch.index > this.nextMatch) this.outputText(this.output, this.nextMatch, terminatorMatch.index);

            // Set the match parameters
            this.matchStart = terminatorMatch.index;
            this.matchLength = terminatorMatch[1].length;
            this.matchText = terminatorMatch[1];
            this.nextMatch = terminatorMatch.index + terminatorMatch[1].length;

            // Restore the output pointer and exit
            this.output = oldOutput;
            return;
        }
        // Check for a formatter match
        else if (formatterMatch) {
            // Output any text before the match
            if (formatterMatch.index > this.nextMatch) this.outputText(this.output, this.nextMatch, formatterMatch.index);

            // Set the match parameters
            this.matchStart = formatterMatch.index;
            this.matchLength = formatterMatch[0].length;
            this.matchText = formatterMatch[0];
            this.nextMatch = this.formatterRegExp.lastIndex;

            // Figure out which formatter matched
            var matchingFormatter = -1;
            for (var t = 1; t < formatterMatch.length; t++)
            if (formatterMatch[t]) matchingFormatter = t - 1;

            // Call the formatter
            if (matchingFormatter != -1) { this.formatters[matchingFormatter].handler(this); }
        }
    }
    while (terminatorMatch || formatterMatch);

    // Output any text after the last match
    if (this.nextMatch < this.source.length) {
        this.outputText(this.output, this.nextMatch, this.source.length);
        this.nextMatch = this.source.length;
    };

    // Restore the output pointer
    this.output = oldOutput;
};

Wikifier.prototype.outputText = function (place, startPos, endPos) {
    insertText(place, this.source.substring(startPos, endPos));
};

Wikifier.prototype.fullArgs = function () {
    var startPos = this.source.indexOf(' ', this.matchStart);
    var endPos = this.source.indexOf('>>', this.matchStart);

    return Wikifier.parse(this.source.slice(startPos, endPos));
};
Wikifier.parse = function (b) {
    function alter(from,to) {
        var g = "(?=(?:[^\"'\\\\]*(?:\\\\.|['\"](?:[^\"'\\\\]*\\\\.)*[^\"'\\\\]*['\"]))*[^'\"]*$)";
        return b.replace(new RegExp(from+g,"gi"),to);
    }
	b = alter("\\$","state.history[0].variables.");
    b = alter("\\beq\\b", " == ");
    b = alter("\\bneq\\b", " != ");
    b = alter("\\bgt\\b", " > ");
    b = alter("\\bgte\\b", " >= ");
    b = alter("\\blt\\b", " < ");
    b = alter("\\blte\\b", " <= ");
    b = alter("\\band\\b", " && ");
    b = alter("\\bor\\b", " || ");
    b = alter("\\bnot\\b", " ! ");
    b = alter("\\bto\\b", " = ");
    return b
};
Wikifier.formatHelpers = {
    charFormatHelper: function (a) {
        var b = insertElement(a.output, this.element);
        a.subWikify(b, this.terminator)
    },
    inlineCssHelper: function (w) {
        var styles = [];
        var lookahead = "(?:(" + Wikifier.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + Wikifier.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
        var lookaheadRegExp = new RegExp(lookahead, "mg");
        var hadStyle = false;
        do {
            lookaheadRegExp.lastIndex = w.nextMatch;
            var lookaheadMatch = lookaheadRegExp.exec(w.source);
            var gotMatch = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
            if (gotMatch) {
                var s, v;
                hadStyle = true;
                if (lookaheadMatch[1]) {
                    s = lookaheadMatch[1].unDash();
                    v = lookaheadMatch[2];
                } else {
                    s = lookaheadMatch[3].unDash();
                    v = lookaheadMatch[4];
                }
                switch (s) {
                case "bgcolor":
                    s = "backgroundColor";
                    break;
                case "float":
                    j = "cssFloat";
                    break
                }
                styles.push({
                    style: s,
                    value: v
                });
                w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
            }
        } while (gotMatch);
        return styles;
    },
    monospacedByLineHelper: function (w) {
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = lookaheadRegExp.exec(w.source);
        if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            var text = lookaheadMatch[1];

            // IE specific hack
            if (navigator.userAgent.indexOf("msie") != -1 && navigator.userAgent.indexOf("opera") == -1) text = text.replace(/\n/g, "\r");
            var e = insertElement(w.output, "pre", null, null, text);
            w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
        }
    }
};
Wikifier.formatters = [
{
    name: "table",
    match: "^\\|(?:[^\\n]*)\\|(?:[fhc]?)$",
    lookahead: "^\\|([^\\n]*)\\|([fhc]?)$",
    rowTerminator: "\\|(?:[fhc]?)$\\n?",
    cellPattern: "(?:\\|([^\\n\\|]*)\\|)|(\\|[fhc]?$\\n?)",
    cellTerminator: "(?:\\x20*)\\|",
    rowTypes: {
        "c": "caption",
        "h": "thead",
        "": "tbody",
        "f": "tfoot"
    },
    handler: function (w) {
        var table = insertElement(w.output, "table");
        w.nextMatch = w.matchStart;
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        var currRowType = null,
            nextRowType;
        var rowContainer, rowElement;
        var prevColumns = [];
        var rowCount = 0;
        do {
            lookaheadRegExp.lastIndex = w.nextMatch;
            var lookaheadMatch = lookaheadRegExp.exec(w.source),
				matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
            if (matched) {
                nextRowType = lookaheadMatch[2];
                if (nextRowType != currRowType) rowContainer = insertElement(table, this.rowTypes[nextRowType]);
                currRowType = nextRowType;
                if (currRowType == "c") {
                    if (rowCount == 0) rowContainer.setAttribute("align", "top");
                    else rowContainer.setAttribute("align", "bottom");
                    w.nextMatch = w.nextMatch + 1;
                    w.subWikify(rowContainer, this.rowTerminator);
                } else {
                    rowElement = insertElement(rowContainer, "tr");
                    this.rowHandler(w, rowElement, prevColumns);
                }
                rowCount++;
            }
        } while (matched);
    },
    rowHandler: function (w, e, prevColumns) {
        var col = 0;
        var currColCount = 1;
        var cellRegExp = new RegExp(this.cellPattern, "mg");
        do {
            cellRegExp.lastIndex = w.nextMatch;
            var cellMatch = cellRegExp.exec(w.source),
				matched = cellMatch && cellMatch.index == w.nextMatch;
            if (matched) {
                if (cellMatch[1] == "~") {
                    var last = prevColumns[col];
                    if (last) {
                        last.rowCount++;
                        last.element.setAttribute("rowSpan", last.rowCount);
                        last.element.setAttribute("rowspan", last.rowCount);
                        last.element.valign = "center";
                    }
                    w.nextMatch = cellMatch.index + cellMatch[0].length - 1;
                } else if (cellMatch[1] == ">") {
                    currColCount++;
                    w.nextMatch = cellMatch.index + cellMatch[0].length - 1;
                } else if (cellMatch[2]) {
                    w.nextMatch = cellMatch.index + cellMatch[0].length;;
                    break;
                } else {
                    var spaceLeft = false,
                        spaceRight = false,
						lastColCount, lastColElement, styles, cell, t;
                    w.nextMatch++;
                    styles = Wikifier.formatHelpers.inlineCssHelper(w);
                    while (w.source.substr(w.nextMatch, 1) == " ") {
                        spaceLeft = true;
                        w.nextMatch++;
                    }
                    if (w.source.substr(w.nextMatch, 1) == "!") {
                        cell = insertElement(e, "th");
                        w.nextMatch++;
                    } else cell = insertElement(e, "td");
                    prevColumns[col] = {
                        rowCount: 1,
                        element: cell
                    };
                    lastColCount = 1;
                    lastColElement = cell;
                    if (currColCount > 1) {
                        cell.setAttribute("colSpan", currColCount);
                        cell.setAttribute("colspan", currColCount);
                        currColCount = 1;
                    }
                    for (t = 0; t < styles.length; t++)
                    cell.style[styles[t].style] = styles[t].value;
                    w.subWikify(cell, this.cellTerminator);
                    if (w.matchText.substr(w.matchText.length - 2, 1) == " ") spaceRight = true;
                    if (spaceLeft && spaceRight) cell.align = "center";
                    else if (spaceLeft) cell.align = "right";
                    else if (spaceRight) cell.align = "left";
                    w.nextMatch = w.nextMatch - 1;
                }
                col++;
            }
        } while (matched);
    }
},
{
    name: "rule",
    match: "^----$\\n?",
    handler: function (w) {
        insertElement(w.output, "hr");
    }
},
{
    name: "emdash",
    match: "--",
    handler: function (w) {
        var e = insertElement(w.output, "span");
        e.innerHTML = '&mdash;';
    }
},
{
    name: "heading",
    match: "^!{1,5}",
    terminator: "\\n",
    handler: function (w) {
        var e = insertElement(w.output, "h" + w.matchLength);
        w.subWikify(e, this.terminator);
    }
},
{
    name: "monospacedByLine",
    match: "^\\{\\{\\{\\n",
    lookahead: "^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)",
    handler: Wikifier.formatHelpers.monospacedByLineHelper
},
{
    name: "monospacedByLineForPlugin",
    match: "^//\\{\\{\\{\\n",
    lookahead: "^//\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^//\\}\\}\\}$\\n?)",
    handler: Wikifier.formatHelpers.monospacedByLineHelper
},
{
    name: "wikifyCommentForPlugin",
    match: "^/\\*\\*\\*\\n",
    terminator: "^\\*\\*\\*/\\n",
    handler: function (w) {
        w.subWikify(w.output, this.terminator);
    }
},
{
    name: "quoteByBlock",
    match: "^<<<\\n",
    terminator: "^<<<\\n",
    handler: function (w) {
        var e = insertElement(w.output, "blockquote");
        w.subWikify(e, this.terminator);
    }
},
{
    name: "quoteByLine",
    match: "^>+",
    terminator: "\\n",
    element: "blockquote",
    handler: function (w) {
        var lookaheadRegExp = new RegExp(this.match, "mg");
        var placeStack = [w.output];
        var currLevel = 0;
        var newLevel = w.matchLength;
        var t;
        do {
            if (newLevel > currLevel) {
                for (t = currLevel; t < newLevel; t++)
                placeStack.push(insertElement(placeStack[placeStack.length - 1], this.element));
            } else if (newLevel < currLevel) {
                for (t = currLevel; t > newLevel; t--)
                placeStack.pop();
            }
            currLevel = newLevel;
            w.subWikify(placeStack[placeStack.length - 1], this.terminator);
            lookaheadRegExp.lastIndex = w.nextMatch;
            var lookaheadMatch = lookaheadRegExp.exec(w.source);
            var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
            if (matched) {
                newLevel = lookaheadMatch[0].length;
                w.nextMatch += lookaheadMatch[0].length;
				insertElement(placeStack[placeStack.length - 1], "br");
            }
        } while (matched);
    }
},
{
    name: "list",
    match: "^(?:(?:\\*+)|(?:#+))",
    lookahead: "^(?:(\\*+)|(#+))",
    terminator: "\\n",
    outerElement: "ul",
    itemElement: "li",
    handler: function (w) {
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        w.nextMatch = w.matchStart;
        var placeStack = [w.output];
        var currType = null,
            newType;
        var currLevel = 0,
            newLevel;
        var t;
        do {
            lookaheadRegExp.lastIndex = w.nextMatch;
            var lookaheadMatch = lookaheadRegExp.exec(w.source);
            var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
            if (matched) {
                if (lookaheadMatch[1]) newType = "ul";
                if (lookaheadMatch[2]) newType = "ol";
                newLevel = lookaheadMatch[0].length;
                w.nextMatch += lookaheadMatch[0].length;
                if (newLevel > currLevel) {
                    for (t = currLevel; t < newLevel; t++)
                    placeStack.push(insertElement(placeStack[placeStack.length - 1], newType));
                } else if (newLevel < currLevel) {
                    for (t = currLevel; t > newLevel; t--)
                    placeStack.pop();
                } else if (newLevel == currLevel && newType != currType) {
                    placeStack.pop();
                    placeStack.push(insertElement(placeStack[placeStack.length - 1], newType));
                }
                currLevel = newLevel;
                currType = newType;
                var e = insertElement(placeStack[placeStack.length - 1], "li");
                w.subWikify(e, this.terminator);
            }
        } while (matched);
    }
},
{
    name: "prettyLink",
    match: "\\[\\[",
    lookahead: "\\[\\[([^\\|\\]]*?)(?:(\\]\\])|(\\|(.*?)\\]\\]))",
    terminator: "\\|",
    handler: function (w) {
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = lookaheadRegExp.exec(w.source)
        if (lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[2]) // Simple bracketted link
        {
            var link = Wikifier.createInternalLink(w.output, lookaheadMatch[1]);
            w.outputText(link, w.nextMatch, w.nextMatch + lookaheadMatch[1].length);
            w.nextMatch += lookaheadMatch[1].length + 2;
        } else if (lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[3]) // Pretty bracketted link
        {
            var e;
            if (tale.has(lookaheadMatch[4])) e = Wikifier.createInternalLink(w.output, lookaheadMatch[4]);
            else e = Wikifier.createExternalLink(w.output, lookaheadMatch[4]);
            w.outputText(e, w.nextMatch, w.nextMatch + lookaheadMatch[1].length);
            w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
        }
    }
},
{
    name: "urlLink",
    match: "(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)",
    handler: function (w) {
        var e = Wikifier.createExternalLink(w.output, w.matchText);
        w.outputText(e, w.matchStart, w.nextMatch);
    }
},
{
    name: "image",
    match: "\\[(?:[<]{0,1})(?:[>]{0,1})[Ii][Mm][Gg]\\[",
    lookahead: "\\[([<]?)(>?)img\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\]?)?(\\])",
    handler: function (w) {
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = lookaheadRegExp.exec(w.source);
        if (lookaheadMatch && lookaheadMatch.index == w.matchStart) // Simple bracketted link
        {
            var e = w.output;
            if (lookaheadMatch[5]) {
                if (tale.has(lookaheadMatch[5])) e = Wikifier.createInternalLink(w.output, lookaheadMatch[5]);
                else e = Wikifier.createExternalLink(w.output, lookaheadMatch[5]);
            }
            var img = insertElement(e, "img");
            if (lookaheadMatch[1]) img.align = "left";
            else if (lookaheadMatch[2]) img.align = "right";
            if (lookaheadMatch[3]) img.title = lookaheadMatch[3];
            img.src = lookaheadMatch[4];
            w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
        }
    }
},
{
    name: "macro",
    match: "<<",
    lookahead: "<<([^>\\s]+)(?:\\s*)((?:[^>]|>(?!>))*)>>",
    handler: function (w) {
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = lookaheadRegExp.exec(w.source)
        if (lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
            var params = lookaheadMatch[2].readMacroParams();
            w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
            try {
                var macro = macros[lookaheadMatch[1]];
                if (macro && macro.handler) macro.handler(w.output, lookaheadMatch[1], params, w);
                else throwError(w.output, 'Macro not found: ' + lookaheadMatch[1]);
            } catch (e) {
                throwError(w.output, 'Error executing macro ' + lookaheadMatch[1] + ': ' + e.toString());
            }
        }
    }
},
{
    name: "html",
    match: "<html>",
    lookahead: "<html>((?:.|\\n)*?)</html>",
    handler: function (w) {
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = lookaheadRegExp.exec(w.source)
        if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            var e = insertElement(w.output, "span");
            e.innerHTML = lookaheadMatch[1];
            w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
        }
    }
},
{
    name: "commentByBlock",
    match: "/%",
    lookahead: "/%((?:.|\\n)*?)%/",
    handler: function (w) {
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = lookaheadRegExp.exec(w.source)
        if (lookaheadMatch && lookaheadMatch.index == w.matchStart) w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
    }
},
{
    name: "boldByChar",
    match: "''",
    terminator: "''",
    element: "strong",
    handler: Wikifier.formatHelpers.charFormatHelper
},
{
    name: "strikeByChar",
    match: "==",
    terminator: "==",
    element: "strike",
    handler: Wikifier.formatHelpers.charFormatHelper
},
{
    name: "underlineByChar",
    match: "__",
    terminator: "__",
    element: "u",
    handler: Wikifier.formatHelpers.charFormatHelper
},
{
    name: "italicByChar",
    match: "//",
    terminator: "//",
    element: "em",
    handler: Wikifier.formatHelpers.charFormatHelper
},
{
    name: "subscriptByChar",
    match: "~~",
    terminator: "~~",
    element: "sub",
    handler: Wikifier.formatHelpers.charFormatHelper
},
{
    name: "superscriptByChar",
    match: "\\^\\^",
    terminator: "\\^\\^",
    element: "sup",
    handler: Wikifier.formatHelpers.charFormatHelper
},
{
    name: "monospacedByChar",
    match: "\\{\\{\\{",
    lookahead: "\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}",
    handler: function (w) {
        var lookaheadRegExp = new RegExp(this.lookahead, "mg");
        lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = lookaheadRegExp.exec(w.source)
        if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            var e = insertElement(w.output, "code", null, null, lookaheadMatch[1]);
            w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
        }
    }
},
{
    name: "styleByChar",
    match: "@@",
    terminator: "@@",
    lookahead: "(?:([^\\(@]+)\\(([^\\)]+)(?:\\):))|(?:([^:@]+):([^;]+);)",
    handler: function (w) {
        var e = insertElement(w.output, "span", null, null, null);
        var styles = Wikifier.formatHelpers.inlineCssHelper(w);
        if (styles.length == 0) e.className = "marked";
        else for (var t = 0; t < styles.length; t++)
        e.style[styles[t].style] = styles[t].value;
        w.subWikify(e, this.terminator);
    }
},
{
    name: "lineBreak",
    match: "\\n",
    handler: function (w) {
        insertElement(w.output, "br");
    }
},
{
    name: "continuedLine",
    match: "\\\\\\n",
    handler: function(a) {
        a.nextMatch = a.matchStart+2;
    }
},
{
	name: "htmltag",
	match: "<\\w+(?:(?:\\s+\\w+(?:\\s*=\\s*(?:\".*?\"|'.*?'|[^'\">\\s]+))?)+\\s*|\\s*)\\/?>",
	tagname: "<(\\w+)",
	voids: ["area", "base", "br", "col", "embed", "hr", "img", "input", "link", "meta", "param", "source", "track", "wbr"],
	handler: function (a) {
		var e, isvoid, lookaheadRegExp, lookaheadMatch, lookahead,
		  doit = false,
		  re = new RegExp(this.tagname).exec(a.matchText),
		  tn = re && re[1];
		if(tn && tn.toLowerCase() != "html") {
			lookahead = "<\\/\\s*" + tn + "\\s*>";
			isvoid = (this.voids.indexOf(tn.toLowerCase()) != -1);
			lookaheadRegExp = new RegExp(lookahead, "mg");
			lookaheadRegExp.lastIndex = a.matchStart;
			lookaheadMatch = lookaheadRegExp.exec(a.source);
			if (lookaheadMatch || isvoid) {
				e = document.createElement(a.output.tagName);
				e.innerHTML = a.matchText;
				e = e.firstChild;
				if (!isvoid) {
					a.subWikify(e, lookahead);
				}
				a.output.appendChild(e);
			} else {
				throwError(a.output,"HTML tag '"+tn+"' wasn't closed.");
			}
		}
	}
}
];
Wikifier.createInternalLink = function (place, title) {
    var el = insertElement(place, 'a', title);
    el.href = 'javascript:void(0)';

    if (tale.has(title)) el.className = 'internalLink';
    else el.className = 'brokenLink';

    el.onclick = function () {
        state.display(title, el)
    };

    if (place) place.appendChild(el);

    return el;
};
Wikifier.createExternalLink = function (place, url) {
    var el = insertElement(place, 'a');
    el.href = url;
    el.className = 'externalLink';
    el.target = '_blank';

    if (place) place.appendChild(el);

    return el;
};
Wikifier.textPrimitives = {};
if (!((new RegExp("[\u0150\u0170]", "g")).test("\u0150"))) {
    Wikifier.textPrimitives.upperLetter = "[A-Z\u00c0-\u00de]";
    Wikifier.textPrimitives.lowerLetter = "[a-z\u00df-\u00ff_0-9\\-]";
    Wikifier.textPrimitives.anyLetter = "[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-]"
} else {
    Wikifier.textPrimitives.upperLetter = "[A-Z\u00c0-\u00de\u0150\u0170]";
    Wikifier.textPrimitives.lowerLetter = "[a-z\u00df-\u00ff_0-9\\-\u0151\u0171]";
    Wikifier.textPrimitives.anyLetter = "[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-\u0150\u0170\u0151\u0171]"
};

/*
**
** Sugarcane/Responsive specific code follows
**
*/
var hasPushState = (typeof window.history.pushState == "function");

Passage.prototype.render = function () {
    var b = insertElement(null, 'div', 'passage' + this.title, 'passage');
    b.style.visibility = 'hidden';
    if (this.tags != null && this.tags.length > 0) b.setAttribute('data-tags', this.tags.join(' '));
    insertElement(b, 'div', '', 'header');
    var a = insertElement(b, 'div', '', 'content');
    new Wikifier(a, this.text);
    insertElement(b, 'div', '', 'footer');
    return b;
};
Passage.prototype.excerpt = function () {
    var b = this.text.replace(/<<.*?>>/g, "");
    b = b.replace(/!.*?\n/g, "");
    b = b.replace(/[\[\]\/]/g, "");
    var a = b.split("\n");
    while (a.length && a[0].length == 0) a.shift();
    var c = '';
    if (a.length == 0 || a[0].length == 0) c = this.title;
    else c = a[0].substr(0, 30) + '...';
    return c;
};
History.prototype.display = function (d, b, a) {
    var c = tale.get(d);
	if (a != "back") {
		this.history.unshift({
			passage: c,
			variables: clone(this.history[0].variables)
		});
		this.history[0].hash = this.save();
		if(this.history.length == 2 && window.history.state === null) {
			window.history.replaceState(this.history, document.title);
		}
		else {
			window.history.pushState(this.history, document.title);
		}
	}
    var e = c.render();
    removeChildren(document.getElementById("passages"));
    document.getElementById("passages").appendChild(e);
    if (a != "quietly") {
        fade(e, {
            fade: "in"
        })
    }
    else {
        e.style.visibility = "visible"
    }
    document.title = tale.title + ": " + c.title;
	if (!hasPushState) {
		this.hash = this.save();
		window.location.hash = this.hash;
	}
    window.scroll(0, 0)
    return e
};

var Interface = {
    init: function () {
		var snapback = document.getElementById("snapback"),
			restart = document.getElementById("restart"),
			share = document.getElementById("share");
        main();
        snapback && (snapback.onclick = Interface.showSnapback);
        restart && (restart.onclick = Interface.restart);
        share && (share.onclick = Interface.showShare);
    },
    restart: function () {
        if (confirm("Are you sure you want to restart this story?")) {
            window.state.restart()
        }
    },
    showShare: function (a) {
        Interface.hideAllMenus();
        Interface.showMenu(a, document.getElementById("shareMenu"))
    },
    showSnapback: function (a) {
        Interface.hideAllMenus();
        Interface.buildSnapback();
        Interface.showMenu(a, document.getElementById("snapbackMenu"))
    },
    buildSnapback: function () {
        var c = false,
			state = window.state,
			menuelem = document.getElementById("snapbackMenu");
		while (menuelem.hasChildNodes()) {
			menuelem.removeChild(menuelem.firstChild)
		}
        for(var a = state.history.length - 1; a >= 0; a--) {
            if(state.history[a].passage && state.history[a].passage.tags.indexOf("bookmark") != -1) {
                var b = document.createElement("div");
				b.pos = a;
                b.onclick = function () {
					var p = this.pos;
					var n = state.history[p].passage.title;
					while(p >= 0) {
						if (state.history.length>1) {
							state.history.shift();
						}
						p--;
					}
					state.display(n);
                };
                b.innerHTML = state.history[a].passage.excerpt();
                menuelem.appendChild(b);
                c = true
            }
        }
        if(!c) {
            var b = document.createElement("div");
            b.innerHTML = "<i>No passages available</i>";
            document.getElementById("snapbackMenu").appendChild(b)
        }
    },
    hideAllMenus: function () {
        document.getElementById("shareMenu").style.display = "none";
        document.getElementById("snapbackMenu").style.display = "none"
    },
    showMenu: function (b, a) {
        if (!b) {
            b = window.event
        }
        var c = {
            x: 0,
            y: 0
        };
        if (b.pageX || b.pageY) {
            c.x = b.pageX;
            c.y = b.pageY
        } else {
            if (b.clientX || b.clientY) {
                c.x = b.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                c.y = b.clientY + document.body.scrollTop + document.documentElement.scrollTop
            }
        }
        a.style.top = c.y + "px";
        a.style.left = c.x + "px";
        a.style.display = "block";
        document.onclick = Interface.hideAllMenus;
        b.cancelBubble = true;
        if (b.stopPropagation) {
            b.stopPropagation()
        }
    }
};
window.onload = Interface.init;

version.extensions.backMacro = {
    major: 2,
    minor: 0,
    revision: 0
};
macros['back'] = {
  labeltext: '&#171; back',
  handler: function (a, b, e) {
    var d = "",
	    labeltouse = this.labeltext,
	    steps = 1,
	    stepsParam = e.indexOf("steps"),
	    stepsParam2 = "",
		labelParam,	c, el;
	// Steps parameter
	if (stepsParam>0) {
		stepsParam2 = e[stepsParam-1];
		if (stepsParam2[0] =='$') {
			try {
				stepsParam2=eval(Wikifier.parse(stepsParam2));
			} catch (r) {
				throwError(a, b+"Macro bad expression: " + r.message)
				return;
			}
		}
		// Previously, trying to go back more steps than were present in the
		// history would silently revert to just 1 step. 
		// Instead, let's just go back to the start.
		steps = +stepsParam2;
		if (steps >= state.history.length-1) {
		  steps = state.history.length-2;
		}
		d = state.history[steps].passage.title;
		e.splice(stepsParam-1,2);
    }
	// Label parameter
	labelParam = e.indexOf("label");
	if (labelParam == -1) {
		labelParam = e.indexOf("labeldefault");
	}
	if (labelParam >-1) {
        if (!e[labelParam+1]) {
            throwError(a, e[labelParam] + 'keyword needs an additional label parameter');
            return;
        }
        labeltouse = e[labelParam+1];
        if (e[labelParam] == 'labeldefault') this.labeltext = labeltouse;
		e.splice(labelParam,2);
	}
	// What's left is the passage name parameter
    if (!d) {
	  if(e[0]) {
	    if (e[0].charAt(0)=='$') {
	        try {
		        e=eval(Wikifier.parse(e[0]));
		    } catch (r) {
                throwError(a, b+"Macro bad expression: " + r.message)
		    	return;
            }
		} 
		else {
		    e = e[0];
		}
        if (tale.get(e).id == undefined) {
          throwError(a, "The " + e + " passage does not exist");
          return;
        }
		for(c = 0; c < state.history.length; c++) {
			if(state.history[c].passage.title == e) {
				d = e;
				steps = c;
				break;
			}
		}
      }
      else {
        d = state.history[1].passage.title;
      }
	}
    if (d==undefined) {
      return;
    } else {
      el = document.createElement("a");
      el.className = "return";
      el.onclick = function () {
	    if (b=="back") {
			if (hasPushState) {
			  window.history.back();
			  return;
			}
			else while(steps >= 0) {
			  if (state.history.length>1) {
				state.history.shift();
			  }
			  steps--;
			}
		}
        state.display(d);
      };
      el.href = "javascript:void(0)";
      el.innerHTML = labeltouse;
      a.appendChild(el);
    }
  }
};
version.extensions.returnMacro = {
    major: 2,
    minor: 0,
    revision: 0
};
macros["return"] = {
  labeltext: '&#171; return',
  handler: function(a,b,e) { 
    macros['back'].handler.call(this,a,b,e);
  }
};
version.extensions.choiceMacro = {
    major: 1,
    minor: 0,
    revision: 0
};
macros.choice = {
    handler: function (a, b, c) {
        Wikifier.createInternalLink(a, c[0])
    }
};
function main() {
	// Used by old custom scripts.
    function $(a) {
        return (typeof a == "string" ? document.getElementById(a) : a);
    }
    tale = window.tale = new Tale();
    state = window.state = new History();
    document.title = tale.title;
    setPageElement("storyTitle", "StoryTitle", "Untitled Story");
    setPageElement("storySubtitle", "StorySubtitle", "");
    if (tale.has("StoryAuthor")) {
        document.getElementById("titleSeparator").innerHTML = "<br>";
        setPageElement("storyAuthor", "StoryAuthor", "");
    }
    if (tale.has("StoryMenu")) {
        document.getElementById("storyMenu").style.display = "inline";
        setPageElement("storyMenu", "StoryMenu", "");
    }
    var scripts = tale.lookup("tags", "script");
    for (var i = 0; i < scripts.length; i++) {
        try {
            eval(scripts[i].text);
        } catch (e) {
            alert("There is a technical problem with this story (" + scripts[i].title + ": " + e.message + "). You may be able to continue reading, but all parts of the story may not work properly.");
        }
    }
    for (var macroidx in macros) {
        var macro = macros[macroidx];
        if (typeof macro.init == "function") {
            macro.init();
        }
    }
    var styles = tale.lookup("tags", "stylesheet");
    for (var i = 0; i < styles.length; i++) {
        addStyle(styles[i].text);
    }
    state.init();
};
}());
</script>
<script>
/* Modernizr 2.5.3 (Custom Build) | MIT & BSD
 * Build: http://www.modernizr.com/download/#-fontface-backgroundsize-borderimage-borderradius-boxshadow-flexbox-hsla-multiplebgs-opacity-rgba-textshadow-cssanimations-csscolumns-generatedcontent-cssgradients-cssreflections-csstransforms-csstransforms3d-csstransitions-applicationcache-canvas-canvastext-draganddrop-hashchange-history-audio-video-indexeddb-input-inputtypes-localstorage-postmessage-sessionstorage-websockets-websqldatabase-webworkers-geolocation-inlinesvg-smil-svg-svgclippaths-touch-webgl-shiv-mq-cssclasses-addtest-prefixed-teststyles-testprop-testallprops-hasevent-prefixes-domprefixes-load
 */
;window.Modernizr=function(a,b,c){function D(a){j.cssText=a}function E(a,b){return D(n.join(a+";")+(b||""))}function F(a,b){return typeof a===b}function G(a,b){return!!~(""+a).indexOf(b)}function H(a,b){for(var d in a)if(j[a[d]]!==c)return b=="pfx"?a[d]:!0;return!1}function I(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return d===!1?a[e]:F(f,"function")?f.bind(d||b):f}return!1}function J(a,b,c){var d=a.charAt(0).toUpperCase()+a.substr(1),e=(a+" "+p.join(d+" ")+d).split(" ");return F(b,"string")||F(b,"undefined")?H(e,b):(e=(a+" "+q.join(d+" ")+d).split(" "),I(e,b,c))}function L(){e.input=function(c){for(var d=0,e=c.length;d<e;d++)u[c[d]]=c[d]in k;return u.list&&(u.list=!!b.createElement("datalist")&&!!a.HTMLDataListElement),u}("autocomplete autofocus list placeholder max min multiple pattern required step".split(" ")),e.inputtypes=function(a){for(var d=0,e,f,h,i=a.length;d<i;d++)k.setAttribute("type",f=a[d]),e=k.type!=="text",e&&(k.value=l,k.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(f)&&k.style.WebkitAppearance!==c?(g.appendChild(k),h=b.defaultView,e=h.getComputedStyle&&h.getComputedStyle(k,null).WebkitAppearance!=="textfield"&&k.offsetHeight!==0,g.removeChild(k)):/^(search|tel)$/.test(f)||(/^(url|email)$/.test(f)?e=k.checkValidity&&k.checkValidity()===!1:/^color$/.test(f)?(g.appendChild(k),g.offsetWidth,e=k.value!=l,g.removeChild(k)):e=k.value!=l)),t[a[d]]=!!e;return t}("search tel url email datetime date month week time datetime-local number range color".split(" "))}var d="2.5.3",e={},f=!0,g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,k=b.createElement("input"),l=":)",m={}.toString,n=" -webkit- -moz- -o- -ms- ".split(" "),o="Webkit Moz O ms",p=o.split(" "),q=o.toLowerCase().split(" "),r={svg:"http://www.w3.org/2000/svg"},s={},t={},u={},v=[],w=v.slice,x,y=function(a,c,d,e){var f,i,j,k=b.createElement("div"),l=b.body,m=l?l:b.createElement("body");if(parseInt(d,10))while(d--)j=b.createElement("div"),j.id=e?e[d]:h+(d+1),k.appendChild(j);return f=["&#173;","<style>",a,"</style>"].join(""),k.id=h,m.innerHTML+=f,m.appendChild(k),l||(m.style.background="",g.appendChild(m)),i=c(k,a),l?k.parentNode.removeChild(k):m.parentNode.removeChild(m),!!i},z=function(b){var c=a.matchMedia||a.msMatchMedia;if(c)return c(b).matches;var d;return y("@media "+b+" { #"+h+" { position: absolute; } }",function(b){d=(a.getComputedStyle?getComputedStyle(b,null):b.currentStyle)["position"]=="absolute"}),d},A=function(){function d(d,e){e=e||b.createElement(a[d]||"div"),d="on"+d;var f=d in e;return f||(e.setAttribute||(e=b.createElement("div")),e.setAttribute&&e.removeAttribute&&(e.setAttribute(d,""),f=F(e[d],"function"),F(e[d],"undefined")||(e[d]=c),e.removeAttribute(d))),e=null,f}var a={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return d}(),B={}.hasOwnProperty,C;!F(B,"undefined")&&!F(B.call,"undefined")?C=function(a,b){return B.call(a,b)}:C=function(a,b){return b in a&&F(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if(typeof c!="function")throw new TypeError;var d=w.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(w.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(w.call(arguments)))};return e});var K=function(c,d){var f=c.join(""),g=d.length;y(f,function(c,d){var f=b.styleSheets[b.styleSheets.length-1],h=f?f.cssRules&&f.cssRules[0]?f.cssRules[0].cssText:f.cssText||"":"",i=c.childNodes,j={};while(g--)j[i[g].id]=i[g];e.touch="ontouchstart"in a||a.DocumentTouch&&b instanceof DocumentTouch||(j.touch&&j.touch.offsetTop)===9,e.csstransforms3d=(j.csstransforms3d&&j.csstransforms3d.offsetLeft)===9&&j.csstransforms3d.offsetHeight===3,e.generatedcontent=(j.generatedcontent&&j.generatedcontent.offsetHeight)>=1,e.fontface=/src/i.test(h)&&h.indexOf(d.split(" ")[0])===0},g,d)}(['@font-face {font-family:"font";src:url("https://")}',["@media (",n.join("touch-enabled),("),h,")","{#touch{top:9px;position:absolute}}"].join(""),["@media (",n.join("transform-3d),("),h,")","{#csstransforms3d{left:9px;position:absolute;height:3px;}}"].join(""),['#generatedcontent:after{content:"',l,'";visibility:hidden}'].join("")],["fontface","touch","csstransforms3d","generatedcontent"]);s.flexbox=function(){return J("flexOrder")},s.canvas=function(){var a=b.createElement("canvas");return!!a.getContext&&!!a.getContext("2d")},s.canvastext=function(){return!!e.canvas&&!!F(b.createElement("canvas").getContext("2d").fillText,"function")},s.webgl=function(){try{var d=b.createElement("canvas"),e;e=!(!a.WebGLRenderingContext||!d.getContext("experimental-webgl")&&!d.getContext("webgl")),d=c}catch(f){e=!1}return e},s.touch=function(){return e.touch},s.geolocation=function(){return!!navigator.geolocation},s.postmessage=function(){return!!a.postMessage},s.websqldatabase=function(){return!!a.openDatabase},s.indexedDB=function(){return!!J("indexedDB",a)},s.hashchange=function(){return A("hashchange",a)&&(b.documentMode===c||b.documentMode>7)},s.history=function(){return!!a.history&&!!history.pushState},s.draganddrop=function(){var a=b.createElement("div");return"draggable"in a||"ondragstart"in a&&"ondrop"in a},s.websockets=function(){for(var b=-1,c=p.length;++b<c;)if(a[p[b]+"WebSocket"])return!0;return"WebSocket"in a},s.rgba=function(){return D("background-color:rgba(150,255,150,.5)"),G(j.backgroundColor,"rgba")},s.hsla=function(){return D("background-color:hsla(120,40%,100%,.5)"),G(j.backgroundColor,"rgba")||G(j.backgroundColor,"hsla")},s.multiplebgs=function(){return D("background:url(https://),url(https://),red url(https://)"),/(url\s*\(.*?){3}/.test(j.background)},s.backgroundsize=function(){return J("backgroundSize")},s.borderimage=function(){return J("borderImage")},s.borderradius=function(){return J("borderRadius")},s.boxshadow=function(){return J("boxShadow")},s.textshadow=function(){return b.createElement("div").style.textShadow===""},s.opacity=function(){return E("opacity:.55"),/^0.55$/.test(j.opacity)},s.cssanimations=function(){return J("animationName")},s.csscolumns=function(){return J("columnCount")},s.cssgradients=function(){var a="background-image:",b="gradient(linear,left top,right bottom,from(#9f9),to(white));",c="linear-gradient(left top,#9f9, white);";return D((a+"-webkit- ".split(" ").join(b+a)+n.join(c+a)).slice(0,-a.length)),G(j.backgroundImage,"gradient")},s.cssreflections=function(){return J("boxReflect")},s.csstransforms=function(){return!!J("transform")},s.csstransforms3d=function(){var a=!!J("perspective");return a&&"webkitPerspective"in g.style&&(a=e.csstransforms3d),a},s.csstransitions=function(){return J("transition")},s.fontface=function(){return e.fontface},s.generatedcontent=function(){return e.generatedcontent},s.video=function(){var a=b.createElement("video"),c=!1;try{if(c=!!a.canPlayType)c=new Boolean(c),c.ogg=a.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,""),c.h264=a.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,""),c.webm=a.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,"")}catch(d){}return c},s.audio=function(){var a=b.createElement("audio"),c=!1;try{if(c=!!a.canPlayType)c=new Boolean(c),c.ogg=a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),c.mp3=a.canPlayType("audio/mpeg;").replace(/^no$/,""),c.wav=a.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),c.m4a=(a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/aac;")).replace(/^no$/,"")}catch(d){}return c},s.localstorage=function(){try{return localStorage.setItem(h,h),localStorage.removeItem(h),!0}catch(a){return!1}},s.sessionstorage=function(){try{return sessionStorage.setItem(h,h),sessionStorage.removeItem(h),!0}catch(a){return!1}},s.webworkers=function(){return!!a.Worker},s.applicationcache=function(){return!!a.applicationCache},s.svg=function(){return!!b.createElementNS&&!!b.createElementNS(r.svg,"svg").createSVGRect},s.inlinesvg=function(){var a=b.createElement("div");return a.innerHTML="<svg/>",(a.firstChild&&a.firstChild.namespaceURI)==r.svg},s.smil=function(){return!!b.createElementNS&&/SVGAnimate/.test(m.call(b.createElementNS(r.svg,"animate")))},s.svgclippaths=function(){return!!b.createElementNS&&/SVGClipPath/.test(m.call(b.createElementNS(r.svg,"clipPath")))};for(var M in s)C(s,M)&&(x=M.toLowerCase(),e[x]=s[M](),v.push((e[x]?"":"no-")+x));return e.input||L(),e.addTest=function(a,b){if(typeof a=="object")for(var d in a)C(a,d)&&e.addTest(d,a[d]);else{a=a.toLowerCase();if(e[a]!==c)return e;b=typeof b=="function"?b():b,g.className+=" "+(b?"":"no-")+a,e[a]=b}return e},D(""),i=k=null,function(a,b){function g(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function h(){var a=k.elements;return typeof a=="string"?a.split(" "):a}function i(a){var b={},c=a.createElement,e=a.createDocumentFragment,f=e();a.createElement=function(a){var e=(b[a]||(b[a]=c(a))).cloneNode();return k.shivMethods&&e.canHaveChildren&&!d.test(a)?f.appendChild(e):e},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+h().join().replace(/\w+/g,function(a){return b[a]=c(a),f.createElement(a),'c("'+a+'")'})+");return n}")(k,f)}function j(a){var b;return a.documentShived?a:(k.shivCSS&&!e&&(b=!!g(a,"article,aside,details,figcaption,figure,footer,header,hgroup,nav,section{display:block}audio{display:none}canvas,video{display:inline-block;*display:inline;*zoom:1}[hidden]{display:none}audio[controls]{display:inline-block;*display:inline;*zoom:1}mark{background:#FF0;color:#000}")),f||(b=!i(a)),b&&(a.documentShived=b),a)}var c=a.html5||{},d=/^<|^(?:button|form|map|select|textarea)$/i,e,f;(function(){var a=b.createElement("a");a.innerHTML="<xyz></xyz>",e="hidden"in a,f=a.childNodes.length==1||function(){try{b.createElement("a")}catch(a){return!0}var c=b.createDocumentFragment();return typeof c.cloneNode=="undefined"||typeof c.createDocumentFragment=="undefined"||typeof c.createElement=="undefined"}()})();var k={elements:c.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:c.shivCSS!==!1,shivMethods:c.shivMethods!==!1,type:"default",shivDocument:j};a.html5=k,j(b)}(this,b),e._version=d,e._prefixes=n,e._domPrefixes=q,e._cssomPrefixes=p,e.mq=z,e.hasEvent=A,e.testProp=function(a){return H([a])},e.testAllProps=J,e.testStyles=y,e.prefixed=function(a,b,c){return b?J(a,b,c):J(a,"pfx")},g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(f?" js "+v.join(" "):""),e}(this,this.document),function(a,b,c){function d(a){return o.call(a)=="[object Function]"}function e(a){return typeof a=="string"}function f(){}function g(a){return!a||a=="loaded"||a=="complete"||a=="uninitialized"}function h(){var a=p.shift();q=1,a?a.t?m(function(){(a.t=="c"?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){a!="img"&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l={},o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};y[c]===1&&(r=1,y[c]=[],l=b.createElement(a)),a=="object"?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),a!="img"&&(r||y[c]===2?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i(b=="c"?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),p.length==1&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&o.call(a.opera)=="[object Opera]",l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return o.call(a)=="[object Array]"},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},A,B;B=function(a){function b(a){var a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a},e,f,g;for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,i){var j=b(a),l=j.autoCallback;j.url.split(".").pop().split("?").shift(),j.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]||h),j.instead?j.instead(a,e,f,g,i):(y[j.url]?j.noexec=!0:y[j.url]=1,f.load(j.url,j.forceCSS||!j.forceJS&&"css"==j.url.split(".").pop().split("?").shift()?"c":c,j.noexec,j.attrs,j.timeout),(d(e)||d(l))&&f.load(function(){k(),e&&e(j.origUrl,i,g),l&&l(j.origUrl,i,g),y[j.url]=2})))}function i(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f,m,n;c(h?a.yep:a.nope,!!i),i&&c(i)}var j,l,m=this.yepnope.loader;if(e(a))g(a,0,m,0);else if(w(a))for(j=0;j<a.length;j++)l=a[j],e(l)?g(l,0,m,0):w(l)?B(l):Object(l)===l&&i(l,m);else Object(a)===a&&i(a,m)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,b.readyState==null&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k=b.createElement("script"),l,o,e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var e=b.createElement("link"),j,c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))};

/*! matchMedia() polyfill - Test a CSS media type/query in JS. Authors & copyright (c) 2012: Scott Jehl, Paul Irish, Nicholas Zakas. Dual MIT/BSD license */
/*! NOTE: If you're already including a window.matchMedia polyfill via Modernizr or otherwise, you don't need this part */
window.matchMedia=window.matchMedia||(function(e,f){var c,a=e.documentElement,b=a.firstElementChild||a.firstChild,d=e.createElement("body"),g=e.createElement("div");g.id="mq-test-1";g.style.cssText="position:absolute;top:-100em";d.style.background="none";d.appendChild(g);return function(h){g.innerHTML='&shy;<style media="'+h+'"> #mq-test-1 { width: 42px; }</style>';a.insertBefore(d,b);c=g.offsetWidth==42;a.removeChild(d);return{matches:c,media:h}}})(document);

/*! Respond.js v1.1.0: min/max-width media query polyfill. (c) Scott Jehl. MIT/GPLv2 Lic. j.mp/respondjs  */
(function(e){e.respond={};respond.update=function(){};respond.mediaQueriesSupported=e.matchMedia&&e.matchMedia("only all").matches;if(respond.mediaQueriesSupported){return}var w=e.document,s=w.documentElement,i=[],k=[],q=[],o={},h=30,f=w.getElementsByTagName("head")[0]||s,g=w.getElementsByTagName("base")[0],b=f.getElementsByTagName("link"),d=[],a=function(){var D=b,y=D.length,B=0,A,z,C,x;for(;B<y;B++){A=D[B],z=A.href,C=A.media,x=A.rel&&A.rel.toLowerCase()==="stylesheet";if(!!z&&x&&!o[z]){if(A.styleSheet&&A.styleSheet.rawCssText){m(A.styleSheet.rawCssText,z,C);o[z]=true}else{if((!/^([a-zA-Z:]*\/\/)/.test(z)&&!g)||z.replace(RegExp.$1,"").split("/")[0]===e.location.host){d.push({href:z,media:C})}}}}u()},u=function(){if(d.length){var x=d.shift();n(x.href,function(y){m(y,x.href,x.media);o[x.href]=true;u()})}},m=function(I,x,z){var G=I.match(/@media[^\{]+\{([^\{\}]*\{[^\}\{]*\})+/gi),J=G&&G.length||0,x=x.substring(0,x.lastIndexOf("/")),y=function(K){return K.replace(/(url\()['"]?([^\/\)'"][^:\)'"]+)['"]?(\))/g,"$1"+x+"$2$3")},A=!J&&z,D=0,C,E,F,B,H;if(x.length){x+="/"}if(A){J=1}for(;D<J;D++){C=0;if(A){E=z;k.push(y(I))}else{E=G[D].match(/@media *([^\{]+)\{([\S\s]+?)$/)&&RegExp.$1;k.push(RegExp.$2&&y(RegExp.$2))}B=E.split(",");H=B.length;for(;C<H;C++){F=B[C];i.push({media:F.split("(")[0].match(/(only\s+)?([a-zA-Z]+)\s?/)&&RegExp.$2||"all",rules:k.length-1,hasquery:F.indexOf("(")>-1,minw:F.match(/\(min\-width:[\s]*([\s]*[0-9\.]+)(px|em)[\s]*\)/)&&parseFloat(RegExp.$1)+(RegExp.$2||""),maxw:F.match(/\(max\-width:[\s]*([\s]*[0-9\.]+)(px|em)[\s]*\)/)&&parseFloat(RegExp.$1)+(RegExp.$2||"")})}}j()},l,r,v=function(){var z,A=w.createElement("div"),x=w.body,y=false;A.style.cssText="position:absolute;font-size:1em;width:1em";if(!x){x=y=w.createElement("body");x.style.background="none"}x.appendChild(A);s.insertBefore(x,s.firstChild);z=A.offsetWidth;if(y){s.removeChild(x)}else{x.removeChild(A)}z=p=parseFloat(z);return z},p,j=function(I){var x="clientWidth",B=s[x],H=w.compatMode==="CSS1Compat"&&B||w.body[x]||B,D={},G=b[b.length-1],z=(new Date()).getTime();if(I&&l&&z-l<h){clearTimeout(r);r=setTimeout(j,h);return}else{l=z}for(var E in i){var K=i[E],C=K.minw,J=K.maxw,A=C===null,L=J===null,y="em";if(!!C){C=parseFloat(C)*(C.indexOf(y)>-1?(p||v()):1)}if(!!J){J=parseFloat(J)*(J.indexOf(y)>-1?(p||v()):1)}if(!K.hasquery||(!A||!L)&&(A||H>=C)&&(L||H<=J)){if(!D[K.media]){D[K.media]=[]}D[K.media].push(k[K.rules])}}for(var E in q){if(q[E]&&q[E].parentNode===f){f.removeChild(q[E])}}for(var E in D){var M=w.createElement("style"),F=D[E].join("\n");M.type="text/css";M.media=E;f.insertBefore(M,G.nextSibling);if(M.styleSheet){M.styleSheet.cssText=F}else{M.appendChild(w.createTextNode(F))}q.push(M)}},n=function(x,z){var y=c();if(!y){return}y.open("GET",x,true);y.onreadystatechange=function(){if(y.readyState!=4||y.status!=200&&y.status!=304){return}z(y.responseText)};if(y.readyState==4){return}y.send(null)},c=(function(){var x=false;try{x=new XMLHttpRequest()}catch(y){x=new ActiveXObject("Microsoft.XMLHTTP")}return function(){return x}})();a();respond.update=a;function t(){j(true)}if(e.addEventListener){e.addEventListener("resize",t,false)}else{if(e.attachEvent){e.attachEvent("onresize",t)}}})(this);
</script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<style>
/* =============================================================================
   HTML5 Boilerplate CSS: h5bp.com/css
   ========================================================================== */

article, aside, details, figcaption, figure, footer, header, hgroup, nav, section { display: block; }
audio, canvas, video { display: inline-block; *display: inline; *zoom: 1; }
audio:not([controls]) { display: none; }
[hidden] { display: none; }

html { font-size: 100%; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
html, button, input, select, textarea { font-family: sans-serif; color: #222; }
body { margin: 0; font-size: 1em; line-height: 1.4em; }

::-moz-selection { background: #fe57a1; color: #fff; text-shadow: none; }
::selection { background: #fe57a1; color: #fff; text-shadow: none; }

a { color: #00e; }
a:visited { color: #551a8b; }
a:hover { color: #06e; }
a:focus { outline: thin dotted; }
a:hover, a:active { outline: 0; }

abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
blockquote { margin: 1em 40px; }
dfn { font-style: italic; }
hr { display: block; height: 1px; border: 0; border-top: 1px solid #ccc; margin: 1em 0; padding: 0; }
ins { background: #ff9; color: #000; text-decoration: none; }
mark { background: #ff0; color: #000; font-style: italic; font-weight: bold; }
pre, code, kbd, samp { font-family: monospace, serif; _font-family: 'courier new', monospace; font-size: 1em; }
pre { white-space: pre; white-space: pre-wrap; word-wrap: break-word; }
q { quotes: none; }
q:before, q:after { content: ""; content: none; }
small { font-size: 85%; }

sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }

ul, ol { margin: 1em 0; padding: 0 0 0 40px; }
dd { margin: 0 0 0 40px; }
nav ul, nav ol { list-style: none; list-style-image: none; margin: 0; padding: 0; }

img { border: 0; -ms-interpolation-mode: bicubic; vertical-align: middle; }

svg:not(:root) { overflow: hidden; }

figure { margin: 0; }

form { margin: 0; }
fieldset { border: 0; margin: 0; padding: 0; }
label { cursor: pointer; }
legend { border: 0; *margin-left: -7px; padding: 0; white-space: normal; }
button, input, select, textarea { font-size: 100%; margin: 0; vertical-align: baseline; *vertical-align: middle; }
button, input { line-height: normal; }
button, input[type="button"], input[type="reset"], input[type="submit"] { cursor: pointer; -webkit-appearance: button; *overflow: visible; }
button[disabled], input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; *width: 13px; *height: 13px; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-decoration, input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; resize: vertical; }
input:valid, textarea:valid {  }
input:invalid, textarea:invalid { background-color: #f0dddd; }

table { border-collapse: collapse; border-spacing: 0; }
td { vertical-align: top; }

.chromeframe { margin: 0.2em 0; background: #ccc; color: black; padding: 0.2em 0; }


/* ===== Initializr Styles =====================================================
   Author: Jonathan Verrecchia - verekia.com/initializr/responsive-template
   Modifications: Emmanuel Turner
   ========================================================================== */

body{ font-family: Helvetica, "Helvetica Neue", Arial, sans-serif; font-size: 12px; line-height: 16px; }

.wrapper{
	width:90%;
	margin:0 5%;
}

/* ===================
    ALL: Grey theme
   =================== */

#header-container{ border-bottom: 20px solid #666; }
#footer-container{ border-top:    20px solid #666; }
#main aside      { border-top:    20px solid #666; }

html, body,
#header-container,
#footer-container,
#main aside{
	background-color: #555;
}
#main-container { background-color: #fff; }

#title{ color:#fff; }

::-moz-selection { background: #f16529; color: #fff; text-shadow: none; }
::selection      { background: #f16529; color: #fff; text-shadow: none; }

/* ==============
    MOBILE: Menu
   ============== */

nav a{
	display:block;
	margin-bottom:10px;
	padding:15px 0;

	background:#666;
	color:#fff;

	text-align:center;
	text-decoration:none;
	font-weight:bold;
}

nav a:hover, nav a:visited{
	color:#fff;
}

nav a:hover{
	text-decoration:underline;
}

/* ==============
    MOBILE: Main
   ============== */

#main{
	padding:0 0 1.5em 0;
}

#main article h1{
	font-size:2em;
}

#main aside{
	color:white;
	padding:0px 5% 10px;
}

#footer-container footer{
	color:white;
	padding:20px 0;
}

/* ===============
    ALL: IE Fixes
   =============== */

.ie7 #title{ padding-top:20px; }


/* ===== Primary Styles ========================================================
   Author:
   ========================================================================== */

#storeArea{display:none; margin:0; padding:0; }
#title { margin-top: 0.25em; margin-bottom: 0.25em; }
#title div { margin: 0; padding: 0; }
#storyTitle, #storySubtitle { float: left; margin-right: 1em; font-size: 2em; line-height: 1em; }
#titleSeparator { display: none; }
#storyAuthor { font-weight: bold; line-height: 1.5em; }
#snapback #restart{margin:0;}
#credits { color:#999; font-size: 0.8em; line-height: 1.0em; }
#credits a { color:#999; text-decoration:none; }
#credits a:hover { text-decoration:underline; }

.menu { position:absolute;display:none;background-color:#666;color:#fff;text-align:left;line-height:2em;}
.menu div{padding:0 .4em;}
.menu div:hover{cursor:pointer;background-color:#fff;color:#666;}

#main-container { padding-top: 1em; }
#passages { font-size: 12px; line-height: 16px; }
.passage ul{padding-top:1.3em;/*text-align:center;*/}
.passage li{/*display:inline;*/margin-right:6em;}
a.internalLink,a.externalLink,a.back,a.return{text-decoration:none;}
a.internalLink:hover,a.externalLink:hover,a.back:hover,a.return:hover{text-decoration:underline;}
a.brokenLink{background-color:#fcc;text-decoration:none;color:#000;}
.marked{background-color:red;color:#000;margin-right:12px;padding:3px;}
.passage ul{margin-left:.5em;padding-left:1.5em;}
.passage ol{margin-left:.5em;padding-left:1.5em;}
.passage table{border-collapse:collapse;font-size:100%;margin:.8em 1.0em;}
.passage th,.passage td,.passage tr,.passage caption{padding:3px;}
.passage hr{height:1px;}
.passage h1, .passage h2, .passage h3 { margin: 0; padding: 0; font-weight: bold; }
.passage h1 { font-size:2em; line-height:2em; margin-top:1em; }
.passage h2 { font-size:1.5em; line-height:1.5em; margin-top:0.5em; }
.passage h3 { font-size:1em; line-height:1.5em; margin-top:0.5em; }

/* =============================================================================
   Media Queries
   ========================================================================== */

@media only screen and (min-width: 480px) {

/* ====================
    INTERMEDIATE: Menu
   ==================== */

	nav a{
		float:left;
		width:25%;
		margin:0 0 0 1.7%;
		padding:1.5em 2%;
		margin-bottom:0;
		margin-top:1.7%;
	}
	
	nav li:last-child a, #storyMenu li:last-child a{ margin-right:0; }
	#title { margin-top: 0.5em; margin-bottom: 0.5em; }
	#passages { font-size: 12px; line-height: 18px; }
	
/* ========================
    INTERMEDIATE: IE Fixes
   ======================== */

	nav ul li{
		display:inline;
	}	
	.oldie nav a{
		margin:0 0.7%;		
	}
}

@media only screen and (min-width: 768px) {

/* ====================
    WIDE: CSS3 Effects
   ==================== */

	#header-container,
	#main aside{
		-webkit-box-shadow:0 5px 10px #aaa;
		   -moz-box-shadow:0 5px 10px #aaa;
		        box-shadow:0 5px 10px #aaa;
	}

/* ============
    WIDE: Menu
   ============ */
	
	#title{
		float:left;
	}

	nav{
		float:right;
		width:38%;
		margin-top: 0.5em;
	}
	#title { margin-top: 1em; margin-bottom: 0.5em; }
	#passages { font-size: 14px; line-height: 21px; width: 640px; }

/* ============
    WIDE: Main
   ============ */

	#main article{
		float:left;
		width:57%;
	}
		
	#main aside{
		float:right;
		width:28%;
	}
}

@media only screen and (min-width: 960px) {

/* ===============
    Maximal Width
   =============== */

	.wrapper{
		width:864px; /* 1140px - 10% for margins */
		margin:0 auto;
	}
	nav { margin-top: 1em; }
	#passages { font-size: 15px; line-height: 23px; width: 640px; }
}

/* =============================================================================
   Non-Semantic Helper Classes
   ========================================================================== */

.ir { display: block; border: 0; text-indent: -999em; overflow: hidden; background-color: transparent; background-repeat: no-repeat; text-align: left; direction: ltr; *line-height: 0; }
.ir br { display: none; }
.hidden { display: none !important; visibility: hidden; }
.visuallyhidden { border: 0; clip: rect(0 0 0 0); height: 1px; margin: -1px; overflow: hidden; padding: 0; position: absolute; width: 1px; }
.visuallyhidden.focusable:active, .visuallyhidden.focusable:focus { clip: auto; height: auto; margin: 0; overflow: visible; position: static; width: auto; }
.invisible { visibility: hidden; }
.clearfix:before, .clearfix:after { content: ""; display: table; }
.clearfix:after { clear: both; }
.clearfix { *zoom: 1; }

/* =============================================================================
   Print Styles
   ========================================================================== */
 
@media print {
  * { background: transparent !important; color: black !important; box-shadow:none !important; text-shadow: none !important; filter:none !important; -ms-filter: none !important; } /* Black prints faster: h5bp.com/s */
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }  /* Don't show links for images, or javascript/internal links */
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; } /* h5bp.com/t */
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3 { orphans: 3; widows: 3; }
  h2, h3 { page-break-after: avoid; }
}
</style>
</head>
<body>
	<div id="header-container">
		<header class="wrapper clearfix">
			<div id="title">
				<div id="storyTitle"></div>
				<div id="storySubtitle"></div>
				<div id="titleSeparator"></div>
				<div class="clearfix"></div>
				<div id="storyAuthor"></div>
			</div>
			<nav>
				<ul>
					<li id="storyMenu"></li>
					<li><a id="snapback" href="javascript:;">Rewind</a></li>
					<li><a id="restart" href="javascript:;">Restart</a></li>
				</ul>
			</nav>
		</header>
	</div>
	<div id="snapbackMenu" class="menu"></div>
	<div id="main-container">
		<div id="main" class="wrapper clearfix">
			<div id="passages"></div>
		</div> <!-- #main -->
	</div> <!-- #main-container -->

	<div id="footer-container">
		<footer class="wrapper">
			<div id="credits">This story was created with <a href="http://gimcrackd.com/etc/src/">Twine</a> and is powered by <a href="http://tiddlywiki.com/">TiddlyWiki</a>. 
			The Responsive Story Format is by <a href="http://www.eturnerx.com">Emmanuel King Turner</a> Twitter: @stormrose and it uses <a href="http://www.initializr.com/">Initializr</a>, <a href="http://jquery.com">jQuery</a> and <a href="http://www.modernizr.com">Modernizr</a>. 
			</div>
		</footer>
	</div>
<div id="storeArea">
